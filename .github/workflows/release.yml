name: Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., 1.0.0)'
        required: true
        type: string

permissions:
  contents: write

jobs:
  build-release:
    name: Build Release Artifacts
    runs-on: windows-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Get version
      id: version
      shell: bash
      run: |
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          echo "version=${{ inputs.version }}" >> $GITHUB_OUTPUT
        else
          echo "version=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
        fi

    # Cache vcpkg packages to speed up builds
    - name: Cache vcpkg packages
      uses: actions/cache@v4
      with:
        path: |
          C:\vcpkg\installed
          C:\vcpkg\packages
        key: vcpkg-openssl-static-${{ runner.os }}-v3
        restore-keys: |
          vcpkg-openssl-static-${{ runner.os }}-

    - name: Install OpenSSL via vcpkg (both architectures)
      shell: cmd
      run: |
        vcpkg integrate install
        vcpkg install openssl:x64-windows-static
        vcpkg install openssl:x86-windows-static

    - name: Verify vcpkg OpenSSL installation
      shell: cmd
      run: |
        echo === x64 Static Libraries ===
        dir "C:\vcpkg\installed\x64-windows-static\lib\*.lib"
        echo.
        echo === x86 Static Libraries ===
        dir "C:\vcpkg\installed\x86-windows-static\lib\*.lib"
        echo.
        echo === x64 Include ===
        dir "C:\vcpkg\installed\x64-windows-static\include\openssl" | head -5

    # ==================== BUILD x64 ====================
    - name: Setup MSVC x64
      uses: ilammy/msvc-dev-cmd@v1
      with:
        arch: x64

    - name: Build x64
      shell: cmd
      run: |
        mkdir build-x64
        cd build-x64
        
        cl /nologo /O2 /W3 /MT /D_CRT_SECURE_NO_WARNINGS /DWIN32 /D_WINDOWS /D_WIN64 ^
           /I"C:\vcpkg\installed\x64-windows-static\include" ^
           /Fe:ftpsmin.exe ^
           ..\src\ftpsmin.c ^
           ..\src\config.c ^
           ..\src\service.c ^
           ..\src\ssl_support.c ^
           ..\src\utf8_support.c ^
           ..\src\vfs.c ^
           /link /SUBSYSTEM:CONSOLE ^
           /LIBPATH:"C:\vcpkg\installed\x64-windows-static\lib" ^
           libssl.lib ^
           libcrypto.lib ^
           ws2_32.lib ^
           advapi32.lib ^
           user32.lib ^
           crypt32.lib ^
           gdi32.lib

    - name: Verify x64 build
      shell: cmd
      run: |
        echo === File size ===
        dir build-x64\ftpsmin.exe
        echo.
        echo === Dependencies (should only show KERNEL32.dll, etc) ===
        dumpbin /dependents build-x64\ftpsmin.exe

    # ==================== BUILD x86 ====================
    - name: Setup MSVC x86
      uses: ilammy/msvc-dev-cmd@v1
      with:
        arch: x86

    - name: Build x86
      shell: cmd
      run: |
        mkdir build-x86
        cd build-x86
        
        cl /nologo /O2 /W3 /MT /D_CRT_SECURE_NO_WARNINGS /DWIN32 /D_WINDOWS ^
           /I"C:\vcpkg\installed\x86-windows-static\include" ^
           /Fe:ftpsmin.exe ^
           ..\src\ftpsmin.c ^
           ..\src\config.c ^
           ..\src\service.c ^
           ..\src\ssl_support.c ^
           ..\src\utf8_support.c ^
           ..\src\vfs.c ^
           /link /SUBSYSTEM:CONSOLE ^
           /LIBPATH:"C:\vcpkg\installed\x86-windows-static\lib" ^
           libssl.lib ^
           libcrypto.lib ^
           ws2_32.lib ^
           advapi32.lib ^
           user32.lib ^
           crypt32.lib ^
           gdi32.lib

    - name: Verify x86 build
      shell: cmd
      run: |
        echo === File size ===
        dir build-x86\ftpsmin.exe
        echo.
        echo === Dependencies (should only show KERNEL32.dll, etc) ===
        dumpbin /dependents build-x86\ftpsmin.exe

    # ==================== PACKAGE ====================
    - name: Create release packages
      shell: powershell
      run: |
        $version = "${{ steps.version.outputs.version }}"
        
        # Create release directory
        New-Item -ItemType Directory -Path "release" -Force
        
        # x64 package
        $x64Dir = "release\ftpsmin-$version-win64"
        New-Item -ItemType Directory -Path $x64Dir -Force
        Copy-Item "build-x64\ftpsmin.exe" "$x64Dir\"
        Copy-Item "README.md" "$x64Dir\" -ErrorAction SilentlyContinue
        Copy-Item "LICENSE" "$x64Dir\" -ErrorAction SilentlyContinue
        
        # Create x64 zip
        Compress-Archive -Path $x64Dir -DestinationPath "release\ftpsmin-$version-win64.zip" -Force
        
        # x86 package
        $x86Dir = "release\ftpsmin-$version-win32"
        New-Item -ItemType Directory -Path $x86Dir -Force
        Copy-Item "build-x86\ftpsmin.exe" "$x86Dir\"
        Copy-Item "README.md" "$x86Dir\" -ErrorAction SilentlyContinue
        Copy-Item "LICENSE" "$x86Dir\" -ErrorAction SilentlyContinue
        
        # Create x86 zip
        Compress-Archive -Path $x86Dir -DestinationPath "release\ftpsmin-$version-win32.zip" -Force
        
        # Show results
        Write-Host "=== Release packages ===" -ForegroundColor Green
        Get-ChildItem "release\*.zip" | ForEach-Object {
            Write-Host "$($_.Name): $([math]::Round($_.Length / 1MB, 2)) MB"
        }

    - name: Generate checksums
      shell: powershell
      run: |
        cd release
        $files = Get-ChildItem -Filter "*.zip"
        $checksums = foreach ($file in $files) {
          $hash = Get-FileHash -Path $file.FullName -Algorithm SHA256
          "$($hash.Hash)  $($file.Name)"
        }
        $checksums | Out-File -Encoding UTF8 -NoNewline "checksums-sha256.txt"
        
        Write-Host "=== Checksums ===" -ForegroundColor Green
        Get-Content "checksums-sha256.txt"

    - name: Upload artifacts (for debugging)
      uses: actions/upload-artifact@v4
      with:
        name: release-packages
        path: release/*.zip
        retention-days: 5

    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      if: startsWith(github.ref, 'refs/tags/')
      with:
        name: ftpsmin v${{ steps.version.outputs.version }}
        draft: false
        prerelease: false
        generate_release_notes: true
        files: |
          release/*.zip
          release/checksums-sha256.txt
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    # Optional: Also create release on manual trigger
    - name: Create GitHub Release (manual)
      uses: softprops/action-gh-release@v1
      if: github.event_name == 'workflow_dispatch'
      with:
        tag_name: v${{ steps.version.outputs.version }}
        name: ftpsmin v${{ steps.version.outputs.version }}
        draft: true
        prerelease: false
        generate_release_notes: true
        files: |
          release/*.zip
          release/checksums-sha256.txt
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}